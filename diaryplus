
<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>Diary + Bot + Notes App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a35; --panel2:#0f1530; --text:#eaf0ff; --muted:#aab4d6;
      --border:#1f2a4f; --accent:#5b8cff; --accent2:#74d680; --warn:#ffcc66; --danger:#ff6b6b;
      --header-height:60px;
    }
    [data-theme="light"]{
      --bg:#f5f7ff; --panel:#ffffff; --panel2:#f3f6ff; --text:#0c1533; --muted:#4a5577;
      --border:#d8def0; --accent:#375dfb; --accent2:#2fbf71; --warn:#f6b84e; --danger:#ef4b4b;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    
    body{
      margin:0; font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif; 
      background:var(--bg); color:var(--text); 
      height:100dvh; width:100vw; overflow:hidden; 
      display:flex; flex-direction:column;
      -webkit-font-smoothing:antialiased;
    }
    
    /* --- HEADER --- */
    header{
      height:var(--header-height); flex-shrink:0; display:flex; align-items:center; gap:12px; padding:0 16px;
      background:var(--panel); border-bottom:1px solid var(--border); z-index:50;
      padding-top: env(safe-area-inset-top);
      justify-content: flex-start;
    }
    .app-title {
        font-size: 20px; font-weight: 800; color: var(--text); flex-grow: 1;
    }
    
    .icon-btn{
      background:transparent; border:none; color:var(--text); font-size:24px; cursor:pointer; 
      padding:8px; display:flex; align-items:center; justify-content:center;
    }

    /* --- SIDEBAR DRAWER --- */
    .sidebar-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 140;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
      backdrop-filter: blur(2px);
    }
    .sidebar-overlay.open { opacity: 1; pointer-events: auto; }

    aside.sidebar {
      position: fixed; top: 0; left: 0; bottom: 0;
      width: 280px; max-width: 80%;
      background: var(--panel); border-right: 1px solid var(--border);
      z-index: 150;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding-top: calc(var(--header-height) + env(safe-area-inset-top));
      display: flex; flex-direction: column;
    }
    aside.sidebar.open { transform: translateX(0); }

    .sidebar-header {
      padding: 20px;
      font-size: 20px; font-weight: 800; color: var(--accent);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }

    .sidebar-nav { padding: 10px; overflow-y: auto; flex: 1; }
    
    .nav-row {
      display: flex; align-items: center; gap: 15px;
      width: 100%; padding: 16px;
      background: transparent; border: none;
      color: var(--muted); font-size: 16px; font-weight: 600;
      text-align: left; cursor: pointer;
      border-radius: 8px; margin-bottom: 4px;
      transition: background 0.2s;
    }
    .nav-row:hover { background: var(--panel2); color: var(--text); }
    .nav-row.active { background: rgba(91,140,255,0.1); color: var(--accent); border-left: 4px solid var(--accent); }
    .nav-row span { font-size: 22px; width: 30px; text-align: center; }

    /* --- MAIN CONTENT --- */
    main{
      flex:1; overflow-y:auto; padding:16px; 
      padding-bottom: 100px;
      -webkit-overflow-scrolling: touch;
      position: relative; z-index: 10;
    }
    .container{max-width:800px; margin:0 auto}

    /* --- FAB --- */
    .fab{
      position:fixed; 
      bottom: calc(20px + env(safe-area-inset-bottom)); 
      right:20px;
      width:60px; height:60px; border-radius:50%; background:var(--accent); color:#fff;
      display:flex; align-items:center; justify-content:center; font-size:32px; 
      box-shadow:0 4px 15px rgba(0,0,0,.4); cursor:pointer; z-index:90; border:none;
    }
    .fab:active{transform:scale(0.95)}

    /* --- COMMON UI --- */
    .hidden{display:none !important}
    .inline{display:flex; gap:10px; align-items:center}
    .grow{flex:1}
    .muted{color:var(--muted); font-size:13px}
    
    .btn{padding:10px 16px; border-radius:10px; border:none; font-weight:600; cursor:pointer; font-size:14px; font-family:inherit}
    .btn.primary{background:var(--accent); color:#fff}
    .btn.secondary{background:var(--panel); border:1px solid var(--border); color:var(--text)}
    .btn.danger{background:var(--danger); color:#fff}
    .btn.sm{padding:6px 12px; font-size:12px}
    .btn.icon{padding:8px; border-radius:50%}
    .btn:active{transform:scale(0.97)}

    input, textarea, select{
      font-family:inherit;font-size:14px;
    }
    input[type="text"],input[type="tel"],input[type="date"],input[type="time"],textarea,select{
      width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);
      background:var(--bg);color:var(--text);outline:none;margin-bottom:12px;
    }
    input:focus,textarea:focus,select:focus{border-color:var(--accent)}

    label{font-size:12px; color:var(--muted); font-weight:700; text-transform:uppercase; margin-bottom:6px; display:block}

    /* Rows */
    .row{display:flex; gap:12px; padding:12px 0; border-bottom:1px solid var(--border); align-items:flex-start}
    .row:last-child{border-bottom:none}
    
    /* History */
    .hist-group-header{
      padding:12px; background:var(--panel); border-radius:10px; font-weight:700; font-size:14px;
      display:flex; justify-content:space-between; align-items:center; cursor:pointer; margin-bottom:8px;
    }
    .hist-content{display:none; padding-left:8px; margin-bottom:12px}
    .expanded .hist-content{display:block}
    
    /* Modals */
    .backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(3px); z-index:200;
      display:none; align-items:center; justify-content:center; padding:16px;
    }
    .modal{
      width:92%; max-width:500px; max-height:85dvh; background:var(--panel); border-radius:18px; 
      padding:0; overflow:hidden; box-shadow:0 20px 50px rgba(0,0,0,0.5);
      border: 1px solid var(--border); display:flex; flex-direction:column;
    }
    .modal-head{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:16px;overflow-y:auto}
    .modal-foot{
      padding:12px 16px;
      border-top:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;
      background:rgba(0,0,0,0.15);
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      gap:8px;
      flex-wrap:wrap;
    }

    /* --- LARGE MODAL SIZE INCREASE --- */
    #modalDiary .modal,
    #modalBot .modal,
    #modalNote .modal {
      width: 95%; 
      max-width: 600px;
      height: 90dvh;
      max-height: 90dvh;
      display: flex;
    }

    /* Toaster */
    #toaster{
      position:fixed;bottom:120px;left:50%;transform:translateX(-50%);
      z-index:300;display:flex;flex-direction:column;gap:10px;width:90%;max-width:400px;
      pointer-events:none;
    }
    #toaster .toast-card{
      pointer-events:auto;
      background:var(--panel2);color:#fff;padding:12px 20px;
      border-radius:50px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.3);
      border:1px solid var(--accent);font-weight:600;
    }

    /* --- Diary/Notes specific styles --- */
    .small{font-size:12px}
    .wrap{flex-wrap:wrap}
    
    .date-header{
      position:sticky; top:72px; z-index:15;
      background:var(--bg); padding:8px 0; font-size:13px; font-weight:700; color:var(--muted);
      border-bottom:1px solid var(--border); margin:16px 0 8px 0; display:flex; align-items:center; gap:8px;
    }
    .date-header::after{content:'';flex:1;height:1px;background:var(--border)}
    
    .entry{
      position:relative; padding:14px; border-radius:8px; border:1px solid var(--border);
      background:rgba(30,41,59,0.5); margin-bottom:10px; cursor:pointer; transition:all .2s;
    }
    .entry:hover{background:var(--panel2);border-color:var(--accent)}
    .entry-body{
      font-size:14px;color:#cbd5e1;margin-top:6px;line-height:1.5;
      overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;
    }
    .note-entry{
      padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:10px;
      background:var(--panel2);
    }
  </style>
</head>
<body>

  <div class="sidebar-overlay" id="sbOverlay" onclick="toggleSidebar()"></div>

  <aside class="sidebar" id="sbMenu">
    <div class="sidebar-header">
      <span>üöÄ App Menu</span>
      <button class="icon-btn" onclick="toggleSidebar()">‚úï</button>
    </div>
    <div class="sidebar-nav">
      <button class="nav-row active" data-target="viewDiary"><span>üìî</span> Diary</button>
      <button class="nav-row" data-target="viewNotes"><span>üóíÔ∏è</span> Notes</button>
      <button class="nav-row" data-target="viewBot"><span>ü§ñ</span> Bot Gen</button>
    </div>
  </aside>

  <header>
    <button class="icon-btn" onclick="toggleSidebar()">‚ò∞</button>
    <div class="app-title">Diary + Bot + Notes</div>
  </header>

  <main>
    <div class="container">
      
      <div id="viewDiary">
        <div class="inline wrap" style="justify-content:space-between; margin-bottom:10px">
          <div class="inline" style="gap:6px">
            <h3 style="margin:0">Diary</h3>
            <span class="muted small">Journal Entries</span>
          </div>
          <button class="btn primary sm" onclick="CT.diary.openEntry()">+ New Entry</button>
        </div>

        <div id="diaryStatus" class="small muted" style="margin-bottom:10px; text-align:right"></div>
        <div id="diaryList"></div>
        <div style="height:80px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:12px">
          &mdash; End of Diary &mdash;
        </div>
      </div>
      
      <div id="viewNotes" class="hidden">
        <div class="inline wrap" style="justify-content:space-between; margin-bottom:10px">
          <h3 style="margin:0">Notes</h3>
          <button class="btn primary sm" onclick="CT.notes.openNote()">+ New Note</button>
        </div>
        <div id="noteList"></div>
      </div>

      <div id="viewBot" class="hidden">
        <div class="inline" style="justify-content:space-between; margin-bottom:12px">
           <h3 style="margin:0">Timeline Queue</h3>
           <div class="muted">Pres ‚Üí Fut</div>
        </div>
        <div id="botHistoryList"></div>
      </div>

    </div>
  </main>

  <button id="fab" class="fab">+</button>

  <div id="modalBot" class="backdrop">
    <div class="modal">
      <div class="modal-head">
        <div class="inline" style="justify-content:space-between;width:100%">
          <h3 style="margin:0">New Command</h3>
          <button class="btn secondary sm" id="btnResetBot">Reset</button>
        </div>
      </div>
      <div class="modal-body">
        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:6px; margin-bottom:12px">
          <button class="btn secondary sm" onclick="CT.bot.smartTime(10,0)">10 AM</button>
          <button class="btn secondary sm" onclick="CT.bot.smartTime(11,0)">11 AM</button>
          <button class="btn secondary sm" onclick="CT.bot.smartTime(15,30)">3:30 PM</button>
          <button class="btn secondary sm" onclick="CT.bot.smartTime(16,0)">4 PM</button>
        </div>
        <div class="inline">
          <div class="grow">
            <label>Date</label>
            <input id="bDate" type="date">
          </div>
          <div class="grow">
            <label>Time</label>
            <input id="bTime" type="time">
          </div>
        </div>
        <div class="inline" style="margin-bottom:10px">
          <button class="btn secondary sm grow" onclick="CT.bot.addDays(1)">+1 Day</button>
          <button class="btn secondary sm grow" onclick="CT.bot.addDays(2)">+2 Days</button>
        </div>
        <label>Message</label>
        <input id="bMsg" type="text" placeholder="Reminder text...">
        
        <div id="botOutput" class="hidden" style="margin-top:15px; display:flex; flex-direction:column; gap:8px"></div>

      </div>
      <div class="modal-foot">
        <button class="btn secondary grow" onclick="closeModals()">Close</button>
        <button id="btnGenBot" class="btn primary grow">Generate & Save</button>
      </div>
    </div>
  </div>
  
  <div id="modalSmartDel" class="backdrop">
    <div class="modal" style="text-align:center">
      <div class="modal-head">
        <h3 style="margin:0">Delete Schedule?</h3>
      </div>
      <div class="modal-body">
        <p class="muted">For <span id="sdDate"></span></p>
      </div>
      <div class="modal-foot" style="flex-direction:column;align-items:stretch">
        <button id="btnEmailDel" class="btn primary" style="width:100%; margin-bottom:8px">üìß Email then Delete</button>
        <button id="btnJustDel" class="btn danger" style="width:100%">üóëÔ∏è Just Delete</button>
      </div>
    </div>
  </div>

  <div id="modalDiary" class="backdrop">
    <div class="modal">
      <div class="modal-head">
        <h3 id="modalDiaryTitle" style="margin:0">Entry</h3>
        <button class="btn secondary sm" onclick="CT.diary.closeEntry()">Esc</button>
      </div>
      <div class="modal-body" style="display: flex; flex-direction: column;">
        <div style="margin-bottom:12px">
          <label>Date</label>
          <input id="enDate" type="date">
        </div>

        <div style="margin-bottom:12px">
          <input id="enTitle" type="text" placeholder="Title" style="font-weight:bold; font-size:16px">
        </div>
        
        <div style="margin-bottom:12px; flex: 1; display: flex; flex-direction: column;">
          <label>Note</label>
          <textarea id="enBody" placeholder="Write your notes here..." oninput="CT.autoGrow(this)" style="flex: 1; min-height: 200px;"></textarea>
        </div>
      </div>
      <div class="modal-foot">
        <div class="inline">
          <button id="deleteDiaryBtn" class="btn danger sm hidden">Delete</button>
          <button id="shareDiaryBtn" class="btn secondary sm">TXT</button>
          <button id="emailDiaryBtn" class="btn secondary sm">Email</button>
        </div>
        <div class="inline">
          <button class="btn secondary sm" onclick="CT.diary.closeEntry()">Cancel</button>
          <button id="saveDiaryBtn" class="btn primary">Save Entry</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="modalNote" class="backdrop">
    <div class="modal">
      <div class="modal-head">
        <h3 id="modalNoteTitle" style="margin:0">Temporary Note</h3>
        <button class="btn secondary sm" onclick="closeModals()">Esc</button>
      </div>
      <div class="modal-body" style="display: flex; flex-direction: column;">
        <label>Note Text</label>
        <textarea id="nBody" placeholder="Jot down a quick thought or number..." oninput="CT.autoGrow(this)" style="min-height: 200px; flex: 1;"></textarea>
      </div>
      <div class="modal-foot">
        <div class="inline">
          <button id="deleteNoteBtn" class="btn danger sm hidden">Delete</button>
          <button id="emailNoteBtn" class="btn secondary sm">Email Note</button>
        </div>
        <div class="inline">
          <button class="btn secondary sm" onclick="closeModals()">Cancel</button>
          <button id="saveNoteBtn" class="btn primary">Save Note</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toaster"></div>

  <script>
    const CT = window.CT || {};
    const q = s => document.querySelector(s);
    const qAll = s => document.querySelectorAll(s);
    const uuid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const nowISO = () => new Date().toISOString();
    const todayISO = () => nowISO().slice(0,10);
    const fmtDate = d => new Date(d).toLocaleDateString(undefined, {weekday:'short', year:'numeric', month:'short', day:'numeric'});

    // Email config (Target emails for the new app)
    const EMAIL_TARGET_DIARY = "my_diary_email@example.com";
    const EMAIL_TARGET_BOT = "my_bot_email@example.com"; 
    const EMAIL_TARGET_NOTES = "my_notes_email@example.com";

    // State
    // Using new local storage keys (db_*) to prevent conflict with the main CRM app
    let botHist = JSON.parse(localStorage.getItem('db_bot') || '[]');
    let diary = JSON.parse(localStorage.getItem('db_diary') || '[]');
    let notes = JSON.parse(localStorage.getItem('db_notes') || '[]');

    let currentView = 'viewDiary';
    let delTargetDate = null;
    let diaryEditingId = null;
    let noteEditingId = null;

    const save = () => {
      localStorage.setItem('db_bot', JSON.stringify(botHist));
      localStorage.setItem('db_diary', JSON.stringify(diary));
      localStorage.setItem('db_notes', JSON.stringify(notes));
      render();
    };

    const toast = (msg, type='info') => {
      const d = document.createElement('div');
      d.className = 'toast-card';
      if(type==='error') d.style.borderColor = 'var(--danger)';
      if(type==='success') d.style.borderColor = 'var(--accent2)';
      d.textContent = msg;
      q('#toaster').appendChild(d);
      setTimeout(()=>d.remove(), 2500);
    };

    /* --- COMMON AUTOGROW FUNCTION --- */
    CT.autoGrow = function(el){
      if(!el) return;
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    };
    
    /* --- SIDEBAR TOGGLE LOGIC --- */
    window.toggleSidebar = function() {
      q('#sbMenu').classList.toggle('open');
      q('#sbOverlay').classList.toggle('open');
    };

    // Sidebar navigation handlers
    qAll('.nav-row').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = btn.dataset.target;
        if(target) {
          qAll('.nav-row').forEach(r => r.classList.remove('active'));
          btn.classList.add('active');
          
          currentView = target;
          ['viewBot','viewDiary', 'viewNotes'].forEach(id=>{
            q('#'+id).classList.add('hidden');
          });
          q('#' + currentView).classList.remove('hidden');
          
          toggleSidebar(); 
          render();
          window.scrollTo(0,0);
        }
      });
    });

    q('#fab').addEventListener('click', () => {
      if(currentView === 'viewDiary') CT.diary.openEntry();
      else if(currentView === 'viewBot') openBotModal();
      else if(currentView === 'viewNotes') CT.notes.openNote();
    });

    /* --- RENDER DISPATCH --- */
    function render(){
      if(currentView === 'viewBot') renderBotHist();
      else if(currentView === 'viewDiary') CT.diary.renderList();
      else if(currentView === 'viewNotes') CT.notes.renderList();
    }
    
    /* --- MODAL CONTROL --- */
    function closeModals(){
      qAll('.backdrop').forEach(e => e.style.display='none');
    }
    window.closeModals = closeModals;

    qAll('.backdrop').forEach(b => {
      b.addEventListener('click', (e)=>{
        if(e.target===b) closeModals();
      });
    });
    
    window.copyText = (txt) => {
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).then(() => toast('Copied!', 'success')).catch(()=>toast('Failed to copy', 'error'));
      } else {
        const el = document.createElement('textarea');
        el.value = txt; document.body.appendChild(el); el.select();
        document.execCommand('copy'); document.body.removeChild(el);
        toast('Copied!', 'success');
      }
    };

    /* ========================================================= */
    /* --- DIARY MODULE --- */
    /* ========================================================= */
    CT.diary = {};

    CT.diary.renderList = function(){
      const elList = q('#diaryList');
      const statusEl = q('#diaryStatus');
      elList.innerHTML = '';
      
      let pool = diary.slice().sort((a,b) => (b.date||"").localeCompare(a.date||"") || (b.createdAt||"").localeCompare(a.createdAt||""));

      statusEl.textContent = `Total Entries: ${diary.length}`;

      if(pool.length === 0){
        elList.innerHTML = `<div style="text-align:center;padding:40px;color:var(--muted)">No diary entries found.</div>`;
        return;
      }

      let lastDate = null;
      const today = todayISO();
      const yest = new Date(Date.now() - 864e5).toISOString().slice(0,10);

      pool.forEach(e => {
        const dRaw = e.date || (e.createdAt||'').slice(0,10) || todayISO();
        if(dRaw !== lastDate){
          const head = document.createElement('div');
          head.className = 'date-header';
          let label = fmtDate(dRaw);
          if(dRaw === today) label = "Today";
          if(dRaw === yest) label = "Yesterday";
          head.innerHTML = `<span>${label}</span>`;
          elList.appendChild(head);
          lastDate = dRaw;
        }

        const div = document.createElement('div');
        div.className = `entry`;
        div.onclick = (ev) => { if(!ev.target.closest('button')) CT.diary.openEntry(e.id); };

        div.innerHTML = `
          <div class="inline" style="justify-content:space-between">
            <strong style="font-size:15px">${e.title || '(No Title)'}</strong>
            <div class="small muted">${dRaw}</div>
          </div>
          ${e.body ? `<div class="entry-body">${e.body}</div>` : ''}
        `;
        elList.appendChild(div);
      });
    };

    CT.diary.openEntry = function(id=null){
      diaryEditingId = id;
      const modal = q('#modalDiary');
      const modalTitle = q('#modalDiaryTitle');
      
      q('#enDate').value = todayISO();

      if(id){
        const e = diary.find(x=>x.id===id);
        modalTitle.textContent = "Edit Entry";
        q('#enDate').value = e.date || todayISO();
        q('#enTitle').value = e.title || '';
        q('#enBody').value = e.body || '';
        q('#deleteDiaryBtn').classList.remove('hidden');
      } else {
        modalTitle.textContent = "New Entry";
        q('#enTitle').value = '';
        q('#enBody').value = '';
        q('#deleteDiaryBtn').classList.add('hidden');
      }
      CT.autoGrow(q('#enBody'));
      modal.style.display='flex';
    };

    CT.diary.closeEntry = function(){
      q('#modalDiary').style.display='none';
    };

    q('#saveDiaryBtn').onclick = () => {
      const title = q('#enTitle').value.trim();
      const body = q('#enBody').value.trim();
      if(!title && !body) return toast('Entry is empty','error');

      const base = {
        id: diaryEditingId || uuid(),
        date: q('#enDate').value || todayISO(),
        title,
        body,
        updatedAt: nowISO()
      };

      if(!diaryEditingId){
        base.createdAt = nowISO();
        diary.push(base);
      } else {
        const idx = diary.findIndex(x=>x.id===diaryEditingId);
        if (idx !== -1) {
            base.createdAt = diary[idx].createdAt;
            diary[idx] = base;
        }
      }
      save();
      CT.diary.closeEntry();
      toast('Entry Saved','success');
    };

    q('#deleteDiaryBtn').onclick = () => {
      if(!diaryEditingId) return;
      if(!confirm('Delete this entry?')) return;
      diary = diary.filter(x=>x.id!==diaryEditingId);
      save();
      CT.diary.closeEntry();
      toast('Entry Deleted','error');
    };

    function diaryEntryToTxt(e){
      return `DATE: ${e.date}\nTITLE: ${e.title || '(No Title)'}\n----------------\n${e.body||''}\n\n`;
    }

    q('#shareDiaryBtn').onclick = () => {
      const e = diary.find(x=>x.id===diaryEditingId);
      if(!e) return;
      const blob = new Blob([diaryEntryToTxt(e)], {type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${(e.title||'entry').replace(/[^a-z0-9]/gi,'_')}.txt`;
      a.click();
      toast('Entry exported as TXT','success');
    };

    q('#emailDiaryBtn').onclick = () => {
      const e = diary.find(x=>x.id===diaryEditingId);
      const subject = `Diary Entry: ${e ? e.title : 'New Entry'}`;
      const body = e ? diaryEntryToTxt(e) : '';
      window.location.href = `mailto:${EMAIL_TARGET_DIARY}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      toast('Email draft opened','info');
    };

    /* ========================================================= */
    /* --- NOTES MODULE --- */
    /* ========================================================= */
    CT.notes = {};

    CT.notes.renderList = function(){
      const list = q('#noteList'); list.innerHTML = '';
      let pool = notes.slice().sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      if(!pool.length){
        list.innerHTML = `<div class="muted" style="text-align:center; padding:20px">No temporary notes.</div>`;
        return;
      }

      pool.forEach(n => {
        const div = document.createElement('div'); div.className = 'note-entry';
        const dateStr = new Date(n.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + ' - ' + new Date(n.createdAt).toLocaleDateString();
        div.innerHTML = `
          <div class="muted" style="font-size:11px; margin-bottom:4px; display:flex; justify-content:space-between">
            <span>${dateStr}</span>
            <button class="btn secondary sm icon" onclick="CT.notes.openNote('${n.id}')" style="padding:4px">‚úèÔ∏è</button>
          </div>
          <div onclick="CT.notes.openNote('${n.id}')" style="cursor:pointer; white-space:pre-wrap;">${n.body}</div>
        `;
        list.appendChild(div);
      });
    };

    CT.notes.openNote = function(id=null){
      noteEditingId = id;
      q('#nBody').value = '';
      q('#deleteNoteBtn').classList.add('hidden');
      if(id){
        const n = notes.find(x=>x.id===id);
        q('#modalNoteTitle').textContent = "Edit Note";
        q('#nBody').value = n.body || '';
        q('#deleteNoteBtn').classList.remove('hidden');
      } else {
        q('#modalNoteTitle').textContent = "New Note";
      }
      CT.autoGrow(q('#nBody'));
      q('#modalNote').style.display='flex';
    };

    q('#saveNoteBtn').onclick = () => {
      const body = q('#nBody').value.trim();
      if(!body) return toast('Note cannot be empty','error');
      
      const newNote = {
        id: noteEditingId || uuid(),
        body: body,
        createdAt: nowISO(),
      };

      if(noteEditingId){
        const idx = notes.findIndex(x=>x.id===noteEditingId);
        if (idx !== -1) {
            notes[idx] = {...notes[idx], body: body, createdAt: notes[idx].createdAt};
        }
      } else {
        notes.push(newNote);
      }
      
      save(); closeModals(); toast('Note Saved','success');
    };

    q('#deleteNoteBtn').onclick = () => {
      if(!noteEditingId) return;
      if(!confirm('Delete this temporary note?')) return;
      notes = notes.filter(n=>n.id!==noteEditingId);
      save(); closeModals(); toast('Note Deleted','error');
    };
    
    q('#emailNoteBtn').onclick = () => {
      const body = q('#nBody').value.trim();
      if(!body) return toast('Note is empty','error');
      const subject = "Temporary Note from App";
      window.location.href = `mailto:${EMAIL_TARGET_NOTES}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      toast('Email draft opened','info');
    };
    
    /* ========================================================= */
    /* --- BOT GENERATOR MODULE --- */
    /* ========================================================= */
    function renderBotHist(){
      const list = q('#botHistoryList'); list.innerHTML = '';
      if(!botHist.length){
        list.innerHTML = `<div class="muted" style="text-align:center; padding:20px">No history. Tap + to add.</div>`;
        return;
      }

      const grouped = {};
      botHist.forEach(i => { if(!grouped[i.date]) grouped[i.date]=[]; grouped[i.date].push(i); });
      
      Object.keys(grouped).sort().forEach(date => {
        const items = grouped[date];
        const div = document.createElement('div');
        div.innerHTML = `
          <div class="hist-group-header" onclick="this.parentElement.classList.toggle('expanded')">
            <span>üìÖ ${date} <span class="muted">(${items.length})</span></span>
            <div class="inline">
              <button class="btn secondary sm" onclick="event.stopPropagation(); promptSmartDel('${date}')">üóëÔ∏è</button>
            </div>
          </div>
          <div class="hist-content">
            ${items.map(i => `
              <div class="row" style="padding:8px 0">
                <div class="muted" style="font-family:monospace; min-width:50px; font-weight:bold; color:var(--accent)">${i.time}</div>
                <div class="grow muted">${i.msg}</div>
                <button class="btn secondary sm" onclick="reuseBot('${i.id}')">üîÑ</button>
              </div>
            `).join('')}
          </div>
        `;
        list.appendChild(div);
      });
    }

    function openBotModal(){ 
      q('#bDate').value=new Date().toISOString().split('T')[0]; 
      q('#bTime').value='10:00'; q('#bMsg').value=''; 
      q('#botOutput').classList.add('hidden'); 
      q('#modalBot').style.display='flex'; 
    }
    window.openBotModal = openBotModal;

    CT.bot = {
      smartTime: (h,m) => { q('#bTime').value = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; },
      addDays: (d) => { 
        const curVal = q('#bDate').value || new Date().toISOString().split('T')[0];
        const cur = new Date(curVal); 
        cur.setDate(cur.getDate()+d); 
        q('#bDate').value = cur.toISOString().split('T')[0]; 
      }
    };

    q('#btnGenBot').onclick = () => {
      const d = q('#bDate').value; const t = q('#bTime').value; const m = q('#bMsg').value;
      if(!d || !t) return toast('Date/Time required','error');
      
      const cleanStr = `remind ${d} ${t} ${m}`;
      const botCmd = `!remind ${d} ${t} ${m}`;
      
      const out = q('#botOutput');
      out.innerHTML = '';
      out.classList.remove('hidden');

      const createRow = (txt) => {
        const d = document.createElement('div');
        d.style.cssText = 'background:var(--bg); padding:10px; border-radius:8px; display:flex; align-items:center; gap:10px; font-family:monospace; font-size:12px; border:1px solid var(--border)';
        d.innerHTML = `
          <div style="flex:1; word-break:break-all">${txt}</div>
          <button class="btn secondary sm" onclick="copyText('${txt.replace(/'/g, "\\'")}')">üìã</button>
        `;
        return d;
      };

      out.appendChild(createRow(botCmd));
      out.appendChild(createRow(cleanStr));
      
      if(!botHist.find(x => x.date===d && x.time===t && x.msg===m)){
        botHist.push({id:uuid(), date:d, time:t, msg:m, clean:cleanStr});
        save();
      }
      toast('Commands Generated','success');
    };

    q('#btnResetBot').onclick = () => {
      q('#bDate').value=new Date().toISOString().split('T')[0]; 
      q('#bTime').value='10:00'; 
      q('#bMsg').value='';
      q('#botOutput').classList.add('hidden');
    };

    window.reuseBot = (id) => {
      const i = botHist.find(x=>x.id===id);
      if(i) { 
        q('#bDate').value=i.date; 
        q('#bTime').value=i.time; 
        q('#bMsg').value=i.msg; 
        q('#botOutput').classList.add('hidden');
        q('#modalBot').style.display='flex'; 
      }
    };

    window.promptSmartDel = (date) => { 
      delTargetDate = date; 
      q('#sdDate').innerText = date; 
      q('#modalSmartDel').style.display='flex'; 
    };

    q('#btnJustDel').onclick = () => { 
      botHist=botHist.filter(i=>i.date!==delTargetDate); 
      save(); closeModals(); 
      toast('Deleted','success');
    };

    q('#btnEmailDel').onclick = () => {
      const items = botHist.filter(i=>i.date===delTargetDate);
      const body = items.map(i => i.clean).join('\n');
      window.location.href = `mailto:${EMAIL_TARGET_BOT}?subject=Schedule ${delTargetDate}&body=${encodeURIComponent(body)}`;
      setTimeout(()=>{ 
        botHist=botHist.filter(i=>i.date!==delTargetDate); 
        save(); closeModals(); 
      }, 2000);
    };
    
    // Initial render sets the default view (Diary)
    render();
  </script>
</body>
</html>
