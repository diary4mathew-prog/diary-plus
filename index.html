<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Diary+</title>
<style>
  :root{ --bg:#f4f6f8; --fg:#101216; --muted:#6b7380; --card:#ffffff;
         --accent:#3b82f6; --accent-weak:#e6efff; --danger:#ef4444; --radius:16px; }
  *{box-sizing:border-box}
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
        background:var(--bg); color:var(--fg); }
  .wrap{max-width:960px; margin:0 auto; padding:16px; display:grid; gap:16px}
  header{display:flex; align-items:center; gap:12px; flex-wrap:wrap; position:sticky; top:0; background:var(--bg); padding:8px 0; z-index:10}
  .title{font-size:1.4rem; font-weight:700; margin-right:auto}
  .search{display:flex; align-items:center; gap:8px; background:var(--card); border:1px solid #e5e7eb; border-radius:999px; padding:8px 12px; min-width:240px}
  .search input{border:none; outline:none; width:220px; background:transparent}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  button{border:none; border-radius:999px; padding:10px 14px; font-weight:600; cursor:pointer; background:var(--accent); color:#fff; transition:.15s transform ease,.2s opacity ease}
  .btn-secondary{background:var(--card); color:var(--fg); border:1px solid #e5e7eb}
  .btn-danger{background:var(--danger); color:#fff}
  .btn-ghost{background:transparent; color:var(--fg)}
  button:active{transform:scale(0.98)}
  .grid{display:grid; grid-template-columns:1fr; gap:16px}
  .card{background:var(--card); border:1px solid #e5e7eb; border-radius:var(--radius); padding:16px}
  .editor-title{display:flex; align-items:center; gap:8px; justify-content:space-between}
  textarea{ width:100%; min-height:160px; resize:vertical; padding:12px; border-radius:12px; border:1px solid #e5e7eb; outline:none; font-size:1rem; line-height:1.5; background:#fff}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .spacer{flex:1}
  .list{display:grid; gap:12px}
  .entry{background:var(--card); border:1px solid #e5e7eb; border-radius:14px; padding:12px; display:grid; gap:8px}
  .entry-head{display:flex; gap:8px; align-items:center}
  .ts{font-size:.85rem; color:var(--muted)}
  .entry-actions{margin-left:auto; display:flex; gap:6px}
  .empty{color:var(--muted); text-align:center; padding:24px}
  .hint{font-size:.9rem; color:var(--muted)}
  .footer{color:var(--muted); text-align:center; font-size:.85rem; padding:8px 0 24px}
  mark{background:#fff59d; padding:0 .1em; border-radius:4px}
  @media (min-width:960px){ .grid{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Diary+</div>
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-3.8-3.8M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#6b7380" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="q" type="search" placeholder="Search entries…" />
      </div>
      <div class="toolbar">
        <button id="btnContact">@ Contact</button>
        <button class="btn-secondary" id="btnExport">Export CSV</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="editor-title">
          <h3 style="margin:0">New Entry</h3>
          <span class="hint" id="permHint"></span>
        </div>
        <textarea id="editor" placeholder="Write your entry here…"></textarea>
        <div class="row">
          <div class="spacer"></div>
          <button id="btnSave">Save</button>
          <button id="btnClear" class="btn-ghost">Clear</button>
        </div>
        <div class="hint">Tip: Use <strong>@ Contact</strong> to insert <em>Name (Phone)</em>. If your browser doesn’t support the Contact Picker API, you’ll get a quick manual prompt.</div>
      </section>

      <section class="card">
        <h3 style="margin-top:0">Your Entries</h3>
        <div id="list" class="list"></div>
        <div id="empty" class="empty" hidden>No entries yet. Start by writing something and press <strong>Save</strong>.</div>
      </section>
    </div>

    <div class="footer">Data is stored locally in your browser (localStorage).</div>
  </div>

<script>
/* Storage */
const LS_ENTRIES = "diary.entries.v1";
function loadEntries(){ try{ return JSON.parse(localStorage.getItem(LS_ENTRIES)) ?? []; }catch{ return []; } }
function saveEntries(arr){ localStorage.setItem(LS_ENTRIES, JSON.stringify(arr)); }

/* State */
let entries = loadEntries(); let editingId = null;

/* Helpers */
function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
function fmtTs(ts){ try{ const d=new Date(ts); return d.toLocaleString(); }catch{ return ts+""; } }
function toCSV(rows){ const esc = s => `"${(s??"").toString().replace(/"/g,'""')}"`;
  const header = ["id","timestamp","text"];
  const data = rows.map(r => [r.id, new Date(r.ts).toISOString(), r.text]);
  return [header, ...data].map(cols => cols.map(esc).join(",")).join("\n"); }
function download(filename, text){ const a=document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type:"text/csv"})); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }
function escapeHTML(s){ return (s??"").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeRegExp(s){ return (s??"").toString().replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function highlight(text, query){ if(!query) return escapeHTML(text); const safe=escapeHTML(text);
  const re=new RegExp(escapeRegExp(query),"gi"); return safe.replace(re, m=>`<mark>${m}</mark>`); }

/* DOM */
const editor = document.getElementById("editor");
const list = document.getElementById("list");
const empty = document.getElementById("empty");
const q = document.getElementById("q");
const permHint = document.getElementById("permHint");

function render(){
  const query = q.value.trim().toLowerCase();
  list.innerHTML = "";
  const filtered = entries.filter(e => e.text.toLowerCase().includes(query));
  if(filtered.length === 0){ empty.hidden=false; return; }
  empty.hidden = true;
  for(const e of filtered.slice().reverse()){
    const card = document.createElement("div"); card.className="entry";
    const head = document.createElement("div"); head.className="entry-head";
    const ts = document.createElement("div"); ts.className="ts"; ts.textContent = fmtTs(e.ts);
    head.appendChild(ts);

    const actions = document.createElement("div"); actions.className="entry-actions";
    const btnEdit = document.createElement("button"); btnEdit.className="btn-secondary"; btnEdit.textContent="Edit";
    btnEdit.onclick = ()=>{ editor.value=e.text; editingId=e.id; editor.scrollIntoView({behavior:"smooth", block:"center"}); };
    actions.appendChild(btnEdit);

    const btnDelete = document.createElement("button"); btnDelete.className="btn-danger"; btnDelete.textContent="Delete";
    btnDelete.onclick = ()=>{ if(!confirm("Delete this entry?")) return; entries = entries.filter(x=>x.id!==e.id); saveEntries(entries); render(); };
    actions.appendChild(btnDelete);

    const btnEmail = document.createElement("button"); btnEmail.className="btn-secondary"; btnEmail.textContent="Email";
    btnEmail.onclick = ()=>{ const subject=encodeURIComponent("Diary Entry – "+fmtTs(e.ts));
      const body=encodeURIComponent(e.text); const to="dairy4mathew@gmail.com";
      window.location.href = `mailto:${to}?subject=${subject}&body=${body}`; };
    actions.appendChild(btnEmail);

    head.appendChild(actions);

    const body = document.createElement("div");
    const queryRaw = q.value.trim(); body.innerHTML = highlight(e.text, queryRaw);

    card.appendChild(head); card.appendChild(body); list.appendChild(card);
  }
}

/* Contact insert with fallback */
async function insertContact(){
  const supports = ('contacts' in navigator) && ('select' in navigator.contacts);
  if(supports){
    try{
      const props=['name','tel']; const opts={multiple:false};
      const chosen = await navigator.contacts.select(props, opts);
      if(!chosen || chosen.length===0){ alert("No contact selected."); return; }
      const c=chosen[0]; const name=(Array.isArray(c.name)?c.name[0]:c.name)||""; const phone=(Array.isArray(c.tel)?c.tel[0]:c.tel)||"";
      if(!name && !phone){ alert("Selected contact has no readable name/phone."); return; }
      appendToEditor(formatContact(name,phone)); return;
    }catch(e){ alert("Could not access contacts. Falling back to manual input."); }
  }
  const name = prompt("Contact name:"); if(name===null) return;
  const phone = prompt("Phone number:"); if(phone===null) return;
  appendToEditor(formatContact(name,phone));
}
function formatContact(name,phone){ const nm=(name||"").trim(); const ph=(phone||"").trim(); return nm&&ph?`${nm} (${ph})`: (nm||ph||""); }
function appendToEditor(text){ if(!text) return; const cur=editor.value; editor.value = (cur?cur+"\n":"")+text; editor.focus(); }

/* Save / Export */
function saveCurrent(){
  const txt=editor.value.trim(); if(!txt){ alert("Write something first."); return; }
  if(editingId){ entries = entries.map(e=>e.id===editingId?{...e, text:txt, ts:Date.now()}:e); editingId=null; }
  else { entries.push({id:uid(), text:txt, ts:Date.now()}); }
  saveEntries(entries); editor.value=""; render();
}
function exportCSV(){ if(entries.length===0){ alert("No entries to export."); return; } download("diary_entries.csv", toCSV(entries)); }

/* Wire UI */
document.getElementById("btnContact").addEventListener("click", insertContact);
document.getElementById("btnSave").addEventListener("click", saveCurrent);
document.getElementById("btnClear").addEventListener("click", ()=>{ editor.value=""; editingId=null; });
document.getElementById("btnExport").addEventListener("click", exportCSV);
q.addEventListener("input", render);

/* First render */
render();
</script>
</body>
</html>
