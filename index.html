<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Diary (Companion)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <style>
    :root{
      --bg: #0f172a; --panel: #1e293b; --panel-hover: #334155;
      --text: #f1f5f9; --muted: #94a3b8; --border: #334155;
      --accent: #3b82f6; --accent-hover: #2563eb;
      --success: #10b981; --warn: #f59e0b; --danger: #ef4444;
      --pro: #6366f1; --pers: #a855f7;
      --font: 'Inter', system-ui, -apple-system, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;padding-bottom:40px}
    
    /* Layout & Header */
    header{position:sticky;top:0;z-index:20;background:rgba(15,23,42,0.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);padding:10px 16px}
    .container{max-width:800px;margin:0 auto;padding:16px}
    .hrow{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:20px;font-weight:700;letter-spacing:-0.02em}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    
    /* Buttons & Inputs */
    button, select, input, textarea{font-family:inherit;font-size:14px}
    .btn{appearance:none;border:none;border-radius:8px;padding:8px 14px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:6px}
    .btn:active{transform:scale(0.97)}
    .btn.primary{background:var(--accent);color:#fff} .btn.primary:hover{background:var(--accent-hover)}
    .btn.secondary{background:var(--panel);border:1px solid var(--border);color:var(--text)} .btn.secondary:hover{background:var(--panel-hover)}
    .btn.ok{background:var(--success);color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.icon{padding:8px;border-radius:50%}
    .btn.sm{padding:4px 10px;font-size:12px;height:28px}

    input[type="text"],input[type="date"],textarea,select{
      width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);
      background:var(--bg);color:var(--text);outline:none;transition:border-color .2s;
    }
    input:focus, textarea:focus, select:focus{border-color:var(--accent)}
    textarea{min-height:100px;resize:vertical;line-height:1.5}
    
    /* Utility Classes */
    .hidden{display:none !important}
    .inline{display:flex;gap:8px;align-items:center}
    .wrap{flex-wrap:wrap}
    .grow{flex:1}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}

    /* Pills & Badges */
    .pill{padding:2px 8px;border-radius:99px;font-size:11px;font-weight:700;text-transform:uppercase}
    .p-pro{background:rgba(99,102,241,0.2);color:#a5b4fc;border:1px solid rgba(99,102,241,0.3)}
    .p-pers{background:rgba(168,85,247,0.2);color:#e9d5ff;border:1px solid rgba(168,85,247,0.3)}
    .p-link{background:rgba(16,185,129,0.2);color:#6ee7b7}
    .p-imp{background:rgba(245,158,11,0.2);color:#fcd34d}

    /* Menu Dropdown */
    .menu-wrap{position:relative}
    .menu-btn{background:transparent;color:var(--text);border:1px solid var(--border)}
    .menu-dropdown{
      position:absolute;top:100%;right:0;margin-top:8px;width:200px;
      background:var(--panel);border:1px solid var(--border);border-radius:8px;
      box-shadow:0 10px 25px rgba(0,0,0,0.5);display:none;flex-direction:column;overflow:hidden;z-index:50;
    }
    .menu-wrap.open .menu-dropdown{display:flex}
    .menu-item{padding:10px 14px;text-align:left;background:none;border:none;color:var(--text);cursor:pointer;border-bottom:1px solid var(--border);font-size:13px}
    .menu-item:hover{background:var(--panel-hover)}
    .menu-item:last-child{border-bottom:none}

    /* List & Timeline */
    .date-header{
      position:sticky; top:65px; z-index:15;
      background:var(--bg); padding:8px 0; font-size:13px; font-weight:700; color:var(--muted);
      border-bottom:1px solid var(--border); margin:20px 0 10px 0; display:flex; align-items:center; gap:8px;
    }
    .date-header::after{content:'';flex:1;height:1px;background:var(--border)}
    
    .entry{
      position:relative; padding:14px; border-radius:8px; border:1px solid var(--border);
      background:rgba(30,41,59,0.5); margin-bottom:10px; cursor:pointer; transition:all .2s;
    }
    .entry:hover{background:var(--panel);border-color:var(--accent)}
    .entry.important{border-left:3px solid var(--warn)}
    
    .entry-body{font-size:14px;color:#cbd5e1;margin-top:6px;line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}
    /* Simple Markdown Styling in List */
    .md-bold{font-weight:700;color:#fff}
    .md-list{display:block;padding-left:10px;border-left:2px solid var(--border);margin:4px 0}
    
    /* Quick Add Accordion */
    details.qa-box{margin-bottom:16px;border:1px solid var(--border);border-radius:8px;background:var(--panel);overflow:hidden}
    details.qa-box summary{padding:10px 14px;cursor:pointer;font-weight:600;font-size:13px;list-style:none;display:flex;align-items:center;justify-content:space-between}
    details.qa-box summary::-webkit-details-marker{display:none}
    details.qa-box summary::after{content:'+';font-size:16px;font-weight:bold}
    details.qa-box[open] summary::after{content:'-'}
    details.qa-box[open] summary{border-bottom:1px solid var(--border)}
    .qa-content{padding:12px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(2px);z-index:100;display:none;align-items:center;justify-content:center;padding:12px}
    .modal{width:100%;max-width:600px;background:#1e293b;border:1px solid var(--border);border-radius:12px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.5);display:flex;flex-direction:column;max-height:90vh}
    .modal-head{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:16px;overflow-y:auto}
    .modal-foot{padding:16px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:rgba(15,23,42,0.3)}

    /* Toast */
    #toaster{position:fixed;bottom:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:10px}
    .toast{background:var(--panel);border-left:4px solid var(--accent);padding:12px 16px;border-radius:4px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.5);font-size:14px;animation:slideIn 0.3s ease}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
  </style>
</head>
<body>

<header>
  <div class="container hrow" style="padding:0">
    <div>
      <h1>Diary</h1>
      <div class="sub">Companion to Tasks</div>
    </div>
    <div class="inline">
      <button class="btn primary" onclick="D.openEntry()">+ New</button>
      
      <div class="menu-wrap" id="mainMenu">
        <button class="btn secondary icon" onclick="this.parentElement.classList.toggle('open')">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <div class="menu-dropdown">
          <button class="menu-item" onclick="D.exportTXT('all')">Export All TXT</button>
          <button class="menu-item" onclick="D.exportTXT('professional')">Export Pro TXT</button>
          <button class="menu-item" onclick="D.exportTXT('personal')">Export Personal TXT</button>
          <button class="menu-item" onclick="D.exportCSV()">Export CSV</button>
          <button class="menu-item" onclick="D.backupJSON()">Backup Data</button>
          <button class="menu-item" onclick="D.importJSON()">Import Backup</button>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="container">

  <div class="inline wrap" style="margin-bottom:16px">
    <input id="search" class="grow" type="text" placeholder="Search entries..." style="background:var(--panel);border-color:transparent">
    <select id="typeFilter" class="btn secondary sm" style="width:auto">
      <option value="any">All Types</option>
      <option value="professional">Professional</option>
      <option value="personal">Personal</option>
    </select>
    <button id="filterImp" class="btn secondary sm" data-active="false" onclick="D.toggleImp(this)">★ Only</button>
  </div>

  <details class="qa-box">
    <summary>Quick Add</summary>
    <div class="qa-content">
      <div class="inline wrap" style="gap:8px; margin-bottom:8px">
        <input id="qaTitle" class="grow" type="text" placeholder="Title...">
        <select id="qaType" style="width:auto; min-width:100px">
          <option value="professional">Pro</option>
          <option value="personal">Pers</option>
        </select>
      </div>
      <div class="inline wrap" style="gap:8px">
        <input id="qaTags" class="grow" type="text" placeholder="#tags...">
        <button id="qaSave" class="btn ok">Add Note</button>
      </div>
    </div>
  </details>

  <div id="dataStatus" class="sub" style="margin-bottom:10px; text-align:right"></div>
  
  <div id="list"></div>
  
  <div style="height:100px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:12px">
    &mdash; End of Diary &mdash;
  </div>
</div>

<div id="entryModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modalTitle" style="margin:0">Entry</h3>
      <button class="btn secondary sm" onclick="D.closeEntry()">Esc</button>
    </div>
    
    <div class="modal-body">
      <div class="inline wrap" style="gap:10px; margin-bottom:12px">
        <div style="flex:1">
          <label class="small muted">Date</label>
          <input id="enDate" type="date">
        </div>
        <div style="flex:1">
          <label class="small muted">Type</label>
          <select id="enType">
            <option value="professional">Professional</option>
            <option value="personal">Personal</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom:12px">
        <input id="enTitle" type="text" placeholder="Title (e.g. Meeting with...)" style="font-weight:bold; font-size:16px">
      </div>
      
      <div class="inline" style="margin-bottom:12px; gap:8px">
        <input id="enTags" type="text" placeholder="Tags (comma separated)...">
        <label class="btn secondary sm" style="cursor:pointer; user-select:none">
          <input id="enImportant" type="checkbox" style="width:auto;margin:0 4px 0 0"> ★
        </label>
      </div>

      <div style="margin-bottom:12px">
        <textarea id="enBody" placeholder="Write your notes here..." oninput="D.autoGrow(this)"></textarea>
      </div>

      <div class="card" style="padding:10px; background:rgba(0,0,0,0.2)">
        <div class="inline" style="justify-content:space-between; margin-bottom:6px">
          <span class="small muted">Link to Task (Optional)</span>
          <button id="prefillFromTask" class="btn secondary sm" style="padding:2px 8px">Copy Task Info</button>
        </div>
        <select id="enTaskLink" style="font-size:12px"></select>
        <div id="enTaskMeta" class="small muted" style="margin-top:6px; font-style:italic"></div>
      </div>
    </div>

    <div class="modal-foot">
      <div class="inline">
        <button id="deleteBtn" class="btn danger sm hidden">Delete</button>
        <button id="shareBtn" class="btn secondary sm">TXT</button>
        <button id="emailBtn" class="btn secondary sm">Email</button>
      </div>
      <div class="inline">
        <button class="btn secondary" onclick="D.closeEntry()">Cancel</button>
        <button id="saveBtn" class="btn primary">Save Entry</button>
      </div>
    </div>
  </div>
</div>

<input id="jsonFile" type="file" accept="application/json" class="hidden"/>
<div id="toaster"></div>

<script>
(function(){
  'use strict';
  const D = window.D = {};

  // Config
  const EMAIL_PRO = "diary4mathew@gmail.com";
  const EMAIL_PERSONAL = "mathewfederal3@hotmail.com";
  
  // Storage Keys (Preserved from previous version)
  const LS = { C: "ct_customers_v1", T: "ct_tasks_v1", L: "ct_leads_v1", D: "ct_diary_v1" };

  // Utils
  const q = s => document.querySelector(s);
  const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
  const nowISO = () => new Date().toISOString();
  const todayISO = () => nowISO().slice(0,10);
  const fmtDate = d => new Date(d).toLocaleDateString(undefined, {weekday:'short', year:'numeric', month:'short', day:'numeric'});
  
  // State
  let data = { C:[], T:[], L:[], D:[] };
  let editingId = null;
  let showImpOnly = false;

  // Load Data
  function loadAll(){
    data.C = JSON.parse(localStorage.getItem(LS.C) || "[]");
    data.T = JSON.parse(localStorage.getItem(LS.T) || "[]");
    data.L = JSON.parse(localStorage.getItem(LS.L) || "[]");
    data.D = JSON.parse(localStorage.getItem(LS.D) || "[]");
    renderList();
  }
  function saveAll(){
    localStorage.setItem(LS.C, JSON.stringify(data.C));
    localStorage.setItem(LS.T, JSON.stringify(data.T));
    localStorage.setItem(LS.L, JSON.stringify(data.L));
    localStorage.setItem(LS.D, JSON.stringify(data.D));
    renderList();
  }

  // Toast
  function toast(msg, type='info'){
    const t = document.createElement('div');
    t.className = 'toast';
    if(type==='error') t.style.borderLeftColor = 'var(--danger)';
    if(type==='success') t.style.borderLeftColor = 'var(--success)';
    t.textContent = msg;
    q('#toaster').appendChild(t);
    setTimeout(()=>t.remove(), 3000);
  }

  // Markdown Formatter (Simple)
  function renderMarkdown(text){
    if(!text) return '';
    let html = text
      .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") // Escape HTML
      .replace(/\*\*(.*?)\*\*/g, '<span class="md-bold">$1</span>') // Bold
      .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic
      .replace(/- (.*?)(\n|$)/g, '<span class="md-list">• $1</span>'); // Lists
    return html.replace(/\n/g, '<br>');
  }

  // Render List
  function renderList(){
    const elList = q('#list');
    elList.innerHTML = '';
    
    // Status
    q('#dataStatus').textContent = `Entries: ${data.D.length} • Tasks: ${data.T.length}`;

    // Filters
    const term = q('#search').value.toLowerCase();
    const typeF = q('#typeFilter').value;
    
    let pool = data.D.slice().sort((a,b) => (b.date||"") .localeCompare(a.date||"") || (b.createdAt||"").localeCompare(a.createdAt||""));

    if(showImpOnly) pool = pool.filter(e => e.important);
    if(typeF !== 'any') pool = pool.filter(e => (e.etype||'professional') === typeF);
    if(term) pool = pool.filter(e => (e.title+e.body+e.tags.join('')).toLowerCase().includes(term));

    let lastDate = null;
    const today = todayISO();
    const yest = new Date(Date.now() - 864e5).toISOString().slice(0,10);

    if(pool.length === 0){
      elList.innerHTML = `<div style="text-align:center;padding:40px;color:var(--muted)">No entries found.</div>`;
      return;
    }

    pool.forEach(e => {
      // Date Header Logic
      const dRaw = e.date || e.createdAt.slice(0,10);
      if(dRaw !== lastDate){
        const head = document.createElement('div');
        head.className = 'date-header';
        let label = fmtDate(dRaw);
        if(dRaw === today) label = "Today";
        if(dRaw === yest) label = "Yesterday";
        head.innerHTML = `<span>${label}</span>`;
        elList.appendChild(head);
        lastDate = dRaw;
      }

      // Card
      const div = document.createElement('div');
      div.className = `entry ${e.important?'important':''}`;
      div.onclick = (ev) => { if(!ev.target.closest('a')) D.openEntry(e.id); };
      
      const typeLabel = (e.etype||'professional') === 'professional' ? 'PRO' : 'PERS';
      const typeClass = (e.etype||'professional') === 'professional' ? 'p-pro' : 'p-pers';
      const linkedTask = e.linkTaskId ? data.T.find(t=>t.id===e.linkTaskId) : null;

      div.innerHTML = `
        <div class="inline" style="justify-content:space-between">
          <div class="inline">
            <span class="pill ${typeClass}">${typeLabel}</span>
            ${e.important ? '<span class="pill p-imp">IMP</span>' : ''}
            ${linkedTask ? '<span class="pill p-link">LINKED</span>' : ''}
            <strong style="font-size:15px">${e.title || '(No Title)'}</strong>
          </div>
          <div class="small muted">${(e.tags||[]).join(', ')}</div>
        </div>
        ${e.body ? `<div class="entry-body">${renderMarkdown(e.body)}</div>` : ''}
      `;
      elList.appendChild(div);
    });
  }

  // Modal Logic
  D.openEntry = (id=null) => {
    editingId = id;
    const m = q('#entryModal');
    const modalTitle = q('#modalTitle');
    
    // Populate Task Select
    const sel = q('#enTaskLink');
    sel.innerHTML = '<option value="">-- No Link --</option>';
    // Sort tasks by recent
    const tasks = data.T.slice().sort((a,b)=> (b.updatedAt||"").localeCompare(a.updatedAt||""));
    tasks.forEach(t => {
      const c = data.C.find(x => x.id === t.customerId);
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = `${c ? c.name.substring(0,15) : 'Unknown'} - ${t.description.substring(0,30)}...`;
      sel.appendChild(opt);
    });

    if(id){
      const e = data.D.find(x=>x.id===id);
      modalTitle.textContent = "Edit Entry";
      q('#enDate').value = e.date || todayISO();
      q('#enType').value = e.etype || 'professional';
      q('#enTitle').value = e.title || '';
      q('#enTags').value = (e.tags||[]).join(', ');
      q('#enImportant').checked = !!e.important;
      q('#enBody').value = e.body || '';
      q('#enTaskLink').value = e.linkTaskId || '';
      q('#deleteBtn').classList.remove('hidden');
    } else {
      modalTitle.textContent = "New Entry";
      q('#enDate').value = todayISO();
      q('#enType').value = 'professional';
      q('#enTitle').value = '';
      q('#enTags').value = '';
      q('#enImportant').checked = false;
      q('#enBody').value = '';
      q('#enTaskLink').value = '';
      q('#deleteBtn').classList.add('hidden');
    }
    
    updateTaskMeta();
    D.autoGrow(q('#enBody'));
    m.style.display = 'flex';
  };

  D.closeEntry = () => { q('#entryModal').style.display = 'none'; };
  D.autoGrow = (el) => { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; };

  // Linking Meta
  function updateTaskMeta(){
    const tid = q('#enTaskLink').value;
    const div = q('#enTaskMeta');
    if(!tid) { div.textContent = ''; return; }
    const t = data.T.find(x=>x.id===tid);
    if(!t) { div.textContent = 'Task not found'; return; }
    const c = data.C.find(x=>x.id===t.customerId);
    div.textContent = `Customer: ${c?c.name:'N/A'} • Status: ${t.status} • Due: ${t.dueDate||'N/A'}`;
  }
  q('#enTaskLink').onchange = updateTaskMeta;

  // Actions
  q('#saveBtn').onclick = () => {
    const title = q('#enTitle').value.trim();
    if(!title) return toast('Title required', 'error');
    
    const entry = {
      id: editingId || uuid(),
      date: q('#enDate').value,
      title: title,
      etype: q('#enType').value,
      tags: q('#enTags').value.split(',').map(s=>s.trim()).filter(Boolean),
      important: q('#enImportant').checked,
      body: q('#enBody').value,
      linkTaskId: q('#enTaskLink').value || null,
      updatedAt: nowISO()
    };
    
    if(!editingId) {
      entry.createdAt = nowISO();
      data.D.push(entry);
    } else {
      const idx = data.D.findIndex(x=>x.id===editingId);
      entry.createdAt = data.D[idx].createdAt;
      data.D[idx] = entry;
    }
    
    saveAll();
    D.closeEntry();
    toast('Entry Saved', 'success');
  };

  q('#deleteBtn').onclick = () => {
    if(confirm('Delete this entry?')){
      data.D = data.D.filter(x=>x.id!==editingId);
      saveAll();
      D.closeEntry();
      toast('Deleted', 'error');
    }
  };

  // Quick Add
  q('#qaSave').onclick = () => {
    const title = q('#qaTitle').value.trim();
    if(!title) return toast('Title required', 'error');
    const entry = {
      id: uuid(),
      date: todayISO(),
      title: title,
      etype: q('#qaType').value,
      tags: q('#qaTags').value.split(',').map(s=>s.trim()).filter(Boolean),
      important: false,
      body: '',
      linkTaskId: null,
      createdAt: nowISO(),
      updatedAt: nowISO()
    };
    data.D.push(entry);
    saveAll();
    q('#qaTitle').value = '';
    q('#qaTags').value = '';
    q('.qa-box').removeAttribute('open'); // Close accordion
    toast('Quick Note Added', 'success');
  };

  // Filters
  q('#search').oninput = renderList;
  q('#typeFilter').onchange = renderList;
  D.toggleImp = (btn) => {
    showImpOnly = !showImpOnly;
    btn.dataset.active = showImpOnly;
    btn.style.background = showImpOnly ? 'var(--warn)' : 'var(--panel)';
    btn.style.color = showImpOnly ? '#000' : 'var(--text)';
    renderList();
  };

  // Prefill
  q('#prefillFromTask').onclick = () => {
    const tid = q('#enTaskLink').value;
    if(!tid) return toast('Select a task first', 'error');
    const t = data.T.find(x=>x.id===tid);
    const c = data.C.find(x=>x.id===t.customerId);
    
    const txt = `\n\n--- Linked Task ---\nCustomer: ${c?c.name:'N/A'}\nDesc: ${t.description}\nStatus: ${t.status}`;
    q('#enBody').value += txt;
    D.autoGrow(q('#enBody'));
    if(!q('#enTitle').value) q('#enTitle').value = `Update on ${c?c.name:'Task'}`;
  };

  // Import/Export
  D.backupJSON = () => {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `Backup_${todayISO()}.json`;
    a.click();
  };

  D.importJSON = () => {
    const inp = q('#jsonFile');
    inp.onchange = (e) => {
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = (res) => {
        try {
          const json = JSON.parse(res.target.result);
          if(json.C) data.C = json.C;
          if(json.T) data.T = json.T;
          if(json.L) data.L = json.L;
          if(json.D) data.D = json.D;
          saveAll();
          toast('Data Imported', 'success');
        } catch(err) { toast('Invalid JSON', 'error'); }
      };
      r.readAsText(f);
    };
    inp.click();
  };

  D.exportCSV = () => {
    const h = ["ID","Date","Title","Type","Body","Tags"];
    const rows = data.D.map(e => [
      e.id, e.date, `"${(e.title||'').replace(/"/g,'""')}"`, e.etype, `"${(e.body||'').replace(/\n/g,' ')}"`, `"${(e.tags||[]).join(',')}"`
    ]);
    const csv = [h.join(',')].concat(rows.map(r=>r.join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Diary_${todayISO()}.csv`;
    a.click();
  };
  
  // TXT Logic
  function entryToTxt(e){
    return `DATE: ${e.date}\nTITLE: ${e.title} [${e.etype}]\nTAGS: ${(e.tags||[]).join(', ')}\n----------------\n${e.body||''}\n\n`;
  }

  D.exportTXT = (mode) => {
    let pool = data.D.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
    if(mode !== 'all') pool = pool.filter(e => e.etype === mode);
    
    const txt = pool.map(entryToTxt).join('================================\n');
    const blob = new Blob([txt], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Diary_${mode}_${todayISO()}.txt`;
    a.click();
  };

  // Individual Share
  q('#shareBtn').onclick = () => {
    const e = data.D.find(x=>x.id===editingId);
    if(!e) return;
    const blob = new Blob([entryToTxt(e)], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${e.title.replace(/[^a-z0-9]/gi,'_')}.txt`;
    a.click();
  };

  // Email
  q('#emailBtn').onclick = () => {
    const e = data.D.find(x=>x.id===editingId);
    const to = (e && e.etype === 'personal') ? EMAIL_PERSONAL : EMAIL_PRO;
    const subject = `Diary: ${e ? e.title : 'New Entry'}`;
    const body = e ? entryToTxt(e) : '';
    window.location.href = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  };

  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    if(!e.target.closest('.menu-wrap')) q('#mainMenu').classList.remove('open');
  });

  loadAll();

})();
</script>
</body>
</html>
